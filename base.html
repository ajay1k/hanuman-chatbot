<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Hanuman Sevak - Connect with the divine">
    <title>{% block title %}{% endblock %}</title>
    <link rel="preload" href="{{ url_for('static', filename='music/hanuman_chalisa.mp3') }}" as="audio">
    <link rel="preload" href="{{ url_for('static', filename='videos/hanuman-bg.mp4') }}" as="video">
    <link rel="preload" href="{{ url_for('static', filename='images/hanuman.jpg') }}" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@700&family=Noto+Serif+Devanagari:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #7B1FA2;
            --secondary: #F57C00;
            --background: #FFF8E1;
            --text: #1A1A1A;
            --neumo-bg: #FFF8E1;
            --neumo-shadow: 8px 8px 16px #d9d2c1, -8px -8px 16px #ffffff;
            --glass-bg: rgba(255, 248, 225, 0.3);
            --glass-border: linear-gradient(135deg, rgba(123, 31, 162, 0.5), rgba(245, 124, 0, 0.5));
        }
        [data-theme="dark"] {
            --primary: #AB47BC;
            --secondary: #EF6C00;
            --background: #120026;
            --text: #EDE7F6;
            --neumo-bg: #120026;
            --neumo-shadow: 8px 8px 16px #0a0018, -8px -8px 16px #1a0034;
            --glass-bg: rgba(18, 0, 38, 0.3);
            --glass-border: linear-gradient(135deg, rgba(171, 71, 188, 0.5), rgba(239, 108, 0, 0.5));
        }
        body {
            color: var(--text);
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            position: relative;
            overflow-x: hidden;
            min-height: 100vh;
            background: var(--background);
        }
        .neumo {
            background: var(--neumo-bg);
            box-shadow: var(--neumo-shadow);
            border-radius: 12px;
        }
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 2px solid transparent;
            border-image: var(--glass-border) 1;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .glass:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }
        .btn-cta {
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-radius: 10px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        .btn-cta:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .btn-cta::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }
        .btn-cta:hover::after {
            width: 200px;
            height: 200px;
        }
        .chat-button {
            animation: pulse 1.5s infinite alternate;
            background: radial-gradient(circle, var(--primary) 50%, var(--secondary) 100%);
        }
        @keyframes pulse {
            from { box-shadow: 0 0 5px var(--primary), 0 0 10px var(--secondary); }
            to { box-shadow: 0 0 15px var(--primary), 0 0 20px var(--secondary); }
        }
        .modal {
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        .modal:not(.hidden) {
            opacity: 1;
            pointer-events: auto;
        }
        .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .tooltip-target:hover .tooltip, .tooltip-target:focus .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .parallax-img {
            transform: translateY(0);
        }
        .chalisa-text {
            font-family: 'Noto Serif Devanagari', serif;
            font-size: 1.1rem;
            line-height: 1.8;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .modal-title {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        .modal-close {
            font-size: 1.5rem;
            transition: transform 0.2s ease, color 0.2s ease;
        }
        .modal-close:hover {
            transform: rotate(90deg);
            color: var(--primary);
        }
        .video-fallback {
            display: none;
            background: linear-gradient(135deg, var(--background), var(--secondary));
        }
    </style>
</head>
<body class="min-h-screen relative">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl sm:text-3xl font-playfair text-[var(--primary)]">{% block header_title %}Hanuman Sevak{% endblock %}</h1>
            <nav class="flex items-center space-x-4">
                {% block header_links %}{% endblock %}
                <button id="theme-toggle" aria-label="Toggle dark/light mode" class="neumo text-[var(--text)] hover:text-[var(--primary)] focus:ring-2 focus:ring-[var(--primary)] rounded-full p-2">
                    <svg id="theme-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </button>
            </nav>
        </header>
        <main class="neumo p-6 sm:p-8 max-w-4xl mx-auto">
            {% block content %}{% endblock %}
        </main>
        <footer class="glass text-center text-sm text-[var(--text)] py-4 mt-6" role="contentinfo">
            <p>Â© <span id="copyright-year">2025</span> Ajay Kattimani. All rights reserved.</p>
            <nav class="mt-2">
                <a href="{{ url_for('terms') }}" class="text-[var(--primary)] hover:underline mx-2">Terms of Use</a>
                <a href="{{ url_for('privacy') }}" class="text-[var(--primary)] hover:underline mx-2">Privacy Policy</a>
            </nav>
        </footer>
    </div>
    <button id="chat-button" class="chat-button fixed bottom-6 right-6 neumo bg-[var(--primary)] text-white p-4 rounded-full shadow-lg btn-cta hover:bg-[var(--secondary)] focus:ring-2 focus:ring-[var(--primary)] focus:ring-offset-2" aria-label="Open chat" title="Chat with Hanuman Sevak">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
        </svg>
    </button>
    <div id="logout-modal" class="modal hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-70" role="dialog" aria-labelledby="logout-title" aria-hidden="true">
        <div class="glass p-8 max-w-md w-full">
            <h3 id="logout-title" class="text-xl modal-title text-[var(--primary)] mb-6">Confirm Logout</h3>
            <p class="text-sm text-[var(--text)] mb-6 text-shadow">Are you sure you want to log out?</p>
            <div class="flex justify-end space-x-4">
                <button id="logout-cancel" class="px-6 py-2 text-[var(--text)] rounded-lg hover:bg-[var(--neumo-bg)] focus:ring-2 focus:ring-[var(--primary)] transition duration-200">Cancel</button>
                <a id="logout-confirm" href="{{ url_for('logout') }}" class="px-6 py-2 bg-[var(--primary)] text-white rounded-lg btn-cta hover:bg-[var(--secondary)] focus:ring-2 focus:ring-[var(--primary)] transition duration-200">Logout</a>
            </div>
        </div>
    </div>
    <script defer>
        // GSAP fallback
        if (typeof gsap === 'undefined') {
            console.warn('GSAP not loaded, animations disabled');
            document.querySelectorAll('header, main, footer').forEach(el => {
                el.style.opacity = 1;
                el.style.transform = 'none';
            });
        } else {
            gsap.from("header", { y: -50, opacity: 0, duration: 1, ease: "power3.out" });
            gsap.from("main", { scale: 0.95, opacity: 0, duration: 1, delay: 0.3, ease: "power3.out" });
        }

        // Dynamic copyright year
        document.getElementById('copyright-year').textContent = new Date().getFullYear();

        // Theme toggle
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const setTheme = (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            themeIcon.innerHTML = theme === 'dark' 
                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />'
                : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />';
        };

        themeToggle?.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            setTheme(currentTheme === 'light' ? 'dark' : 'light');
            if (typeof gsap !== 'undefined') {
                gsap.to(".video-overlay", { 
                    background: currentTheme === 'light' 
                        ? "rgba(18, 0, 38, 0.3)" 
                        : "rgba(255, 248, 225, 0.3)", 
                    duration: 0.5 
                });
            }
        });

        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);

        // Chat button
        const chatButton = document.getElementById('chat-button');
        chatButton?.addEventListener('click', () => {
            if (typeof gsap !== 'undefined') {
                gsap.to(chatButton, { scale: 0.9, duration: 0.2, yoyo: true, repeat: 1 });
            }
            setTimeout(() => {
                try {
                    window.location.href = '{{ url_for("chat") }}';
                } catch (e) {
                    console.error('Navigation failed:', e);
                    alert('Error navigating to chat. Please check your server configuration.');
                }
            }, 400);
        });

        // Logout modal
        const logoutModal = document.getElementById('logout-modal');
        const logoutCancel = document.getElementById('logout-cancel');
        const logoutConfirm = document.getElementById('logout-confirm');
        const logoutLinks = document.querySelectorAll('.logout-link');
        logoutLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                logoutModal.classList.remove('hidden');
                logoutModal.setAttribute('aria-hidden', 'false');
                if (typeof gsap !== 'undefined') {
                    gsap.from("#logout-modal .glass", { 
                        scale: 0.9, 
                        opacity: 0, 
                        duration: 0.5, 
                        ease: "elastic.out(1, 0.5)" 
                    });
                }
            });
        });

        logoutCancel?.addEventListener('click', () => {
            if (typeof gsap !== 'undefined') {
                gsap.to("#logout-modal .glass", { 
                    scale: 0.9, 
                    opacity: 0, 
                    duration: 0.3, 
                    ease: "power2.in", 
                    onComplete: () => {
                        logoutModal.classList.add('hidden');
                        logoutModal.setAttribute('aria-hidden', 'true');
                    }
                });
            } else {
                logoutModal.classList.add('hidden');
                logoutModal.setAttribute('aria-hidden', 'true');
            }
        });

        logoutConfirm?.addEventListener('click', async (e) => {
            try {
                const response = await fetch('{{ url_for("logout") }}', { method: 'POST' });
                if (response.ok) {
                    window.location.href = '{{ url_for("login") }}';
                } else {
                    throw new Error('Logout failed');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error logging out. Please try again.');
            }
        });

        // Page-specific scripts
        {% block additional_scripts %}{% endblock %}
    </script>
</body>
</html>